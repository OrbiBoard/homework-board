<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>添加作业</title>
  <style>
    /* Theme Variables Default (Dark) */
    :root {
      --bg: #121621;
      --fg: #ededed;
      --muted: #94a3b8;
      --accent: #238f4a;
      --panel: rgba(255, 255, 255, 0.04);
      --item-bg: rgba(255, 255, 255, 0.04);
      --border: rgba(255, 255, 255, 0.12);
      --bg-modal: #1b1f2a;
      --accent-rgb: 35, 143, 74;
      --danger: #dc2626;
    }

    body { 
      font-family: system-ui, -apple-system, "Microsoft YaHei", sans-serif; 
      padding: 24px; 
      background: var(--bg-modal); 
      color: var(--fg); 
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .header-title {
      font-size: 20px; 
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="date"] {
      background: var(--item-bg);
      color: var(--fg);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: inherit;
      outline: none;
    }

    .homework-list {
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      background: var(--panel);
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .homework-item {
      display: grid;
      grid-template-columns: 100px 1fr auto;
      gap: 12px;
      align-items: start;
      background: var(--item-bg);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }
    
    .homework-item:hover {
      border-color: var(--border);
    }
    
    .homework-item input, .homework-item textarea {
      background: transparent;
      border: 1px solid transparent;
      color: var(--fg);
      padding: 8px;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
      transition: background 0.2s;
    }
    
    .homework-item input:focus, .homework-item textarea:focus {
      background: rgba(255, 255, 255, 0.05);
      outline: none;
    }
    
    .input-subject { 
      font-weight: 600; 
      color: var(--accent);
      text-align: center;
      background: rgba(var(--accent-rgb), 0.1) !important;
    }

    .input-content { 
      min-height: 38px; 
      line-height: 1.5; 
    }
    
    .btn-icon {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-icon:hover { 
      background: rgba(255,255,255,0.1); 
      color: var(--fg); 
    }
    .btn-delete:hover { 
      background: rgba(220, 38, 38, 0.15);
      color: var(--danger); 
    }

    .footer {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px; 
      cursor: pointer; 
      border-radius: 8px; 
      font-size: 14px; 
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      background: var(--item-bg);
      color: var(--fg);
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: var(--border);
    }
    
    .btn.primary {
      background: var(--accent); 
      color: white; 
      border-color: transparent; 
    }
    .btn.primary:hover { 
      filter: brightness(1.1); 
    }
    
    .btn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      filter: grayscale(1);
    }

    .status { margin-left: auto; color: var(--muted); font-size: 13px; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* Debug Console */
    #debug-console {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 200px;
        background: #0f1115;
        border-top: 1px solid var(--border);
        display: none;
        flex-direction: column;
        z-index: 1000;
        font-family: monospace;
        font-size: 12px;
    }
    #debug-header {
        padding: 5px 10px;
        background: #1b1f2a;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--muted);
    }
    #debug-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        color: #ccc;
        white-space: pre-wrap;
    }
    .log-time { color: var(--muted); margin-right: 8px; }
    .log-info { color: #61dafb; }
    .log-error { color: #ff6b6b; }
    .log-success { color: #51cf66; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title"><i class="ri-edit-2-line"></i> 编辑作业</div>
    <input type="date" id="date-picker">
  </div>

  <div class="homework-list" id="homework-list">
    <!-- Items will be injected here -->
  </div>

  <div class="footer">
    <button class="btn" id="btn-add-row"><i class="ri-add-line"></i> 添加科目</button>
    <button class="btn primary" id="btn-save"><i class="ri-save-line"></i> 保存更改</button>
    <button class="btn" id="btn-debug" onclick="toggleDebug()" style="margin-left: 8px; opacity: 0.5;"><i class="ri-bug-line"></i> Debug</button>
    <span id="status-msg" class="status"></span>
  </div>

  <div id="debug-console">
      <div id="debug-header">
          <span>Debug Console</span>
          <div>
            <button onclick="clearDebug()" class="btn-icon" style="display:inline-block; font-size: 12px; padding: 2px 6px;">Clear</button>
            <button onclick="toggleDebug()" class="btn-icon" style="display:inline-block; font-size: 12px; padding: 2px 6px;">Close</button>
          </div>
      </div>
      <div id="debug-content"></div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    // Debug Logic
    function toggleDebug() {
        const consoleEl = document.getElementById('debug-console');
        const isHidden = consoleEl.style.display === 'none' || consoleEl.style.display === '';
        consoleEl.style.display = isHidden ? 'flex' : 'none';
        if (isHidden) {
            // Adjust body height or padding if needed, but absolute positioning is fine
        }
    }

    function clearDebug() {
        document.getElementById('debug-content').innerHTML = '';
    }

    function logDebug(msg, data = null, type = 'info') {
        const content = document.getElementById('debug-content');
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString();
        
        let dataStr = '';
        if (data !== null) {
            try {
                dataStr = '\n' + JSON.stringify(data, null, 2);
            } catch(e) {
                dataStr = '\n[Circular/Unserializable]';
            }
        }
        
        div.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span>${dataStr}`;
        div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
        div.style.padding = '4px 0';
        
        content.appendChild(div);
        content.scrollTop = content.scrollHeight;
        console.log(`[Debug] ${msg}`, data || '');
    }

    // Capture console errors
    const originalConsoleError = console.error;
    console.error = (...args) => {
        originalConsoleError.apply(console, args);
        logDebug(args.map(a => String(a)).join(' '), null, 'error');
    };

    // Theme Logic
    const adjustBrightness = (hex, percent) => {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (
        0x1000000 +
        (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255)
      ).toString(16).slice(1);
    };

    const applyTheme = (mode, color) => {
      const root = document.documentElement;
      const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      const accent = color || '#238f4a';
      root.style.setProperty('--accent', accent);
      
      const hex = accent.replace('#', '');
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);
      root.style.setProperty('--accent-rgb', `${r}, ${g}, ${b}`);
      
      if (isDark) {
        root.style.setProperty('--bg', '#121621');
        root.style.setProperty('--fg', '#ededed');
        root.style.setProperty('--muted', '#94a3b8');
        root.style.setProperty('--panel', 'rgba(255, 255, 255, 0.04)');
        root.style.setProperty('--item-bg', 'rgba(255, 255, 255, 0.04)');
        root.style.setProperty('--border', 'rgba(255, 255, 255, 0.12)');
        root.style.setProperty('--bg-modal', '#1b1f2a');
      } else {
        root.style.setProperty('--bg', '#f3f4f6');
        root.style.setProperty('--fg', '#1f2937');
        root.style.setProperty('--muted', '#6b7280');
        root.style.setProperty('--panel', '#ffffff');
        root.style.setProperty('--item-bg', '#f9fafb');
        root.style.setProperty('--border', '#e5e7eb');
        root.style.setProperty('--bg-modal', '#ffffff');
      }
    };

    (async () => {
        // Init Icons
        try {
            const url = await ipcRenderer.invoke('asset:url', 'remixicon-local.css');
            if (url) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = url;
                document.head.appendChild(link);
            }
        } catch(e) { console.error('Failed to load icons', e); }

        // Init Theme
        try {
            let cfg = {};
            try {
                cfg = await ipcRenderer.invoke('config:get-all', 'system');
            } catch (err) {
                console.warn('Config load failed, using defaults:', err.message);
            }
            const mode = cfg?.themeMode || 'system';
            const color = cfg?.themeColor || '#238f4a';
            applyTheme(mode, color);
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
              if (mode === 'system') applyTheme('system', color);
            });
        } catch (e) { console.error('Theme init failed', e); }
    })();

    // App Logic
    const listContainer = document.getElementById('homework-list');
    const defaultSubjects = ['语文', '数学', '英语', '物理', '化学', '生物'];

    const getLocalISODate = () => {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    const today = getLocalISODate();
    document.getElementById('date-picker').value = today;

    loadHomework(today);

    document.getElementById('date-picker').addEventListener('change', (e) => {
        loadHomework(e.target.value);
    });

    async function loadHomework(date) {
        listContainer.innerHTML = '';
        logDebug(`Loading homework for ${date}...`);
        try {
            const res = await ipcRenderer.invoke('plugin:call', 'homework-board', 'getHomework', [date]);
            logDebug('Load response received', res);
            
            // Handle wrapper { ok: true, result: { ... } } or direct { ok: true, data: ... }
            const payload = (res.result && res.result.ok) ? res.result : res;
            
            let data = [];
            
            if (payload && payload.ok && payload.data) {
                const rawData = payload.data;
                if (typeof rawData === 'string') {
                    try {
                        const parsed = JSON.parse(rawData);
                        logDebug('Parsed JSON string', parsed);
                        if (Array.isArray(parsed)) data = parsed;
                        else data = [{ subject: '备注', content: rawData }];
                    } catch {
                        logDebug('Raw string content (not JSON)', rawData);
                        if (rawData.trim()) data = [{ subject: '作业', content: rawData }];
                    }
                } else if (Array.isArray(rawData)) {
                    logDebug('Received Array data', rawData);
                    data = rawData;
                } else if (typeof rawData === 'object') {
                    logDebug('Received Object data', rawData);
                    // Handle single object case (legacy or single item)
                    data = [rawData];
                }
            } else {
                logDebug('No data found or empty response', payload);
            }

            if (data.length === 0) {
                defaultSubjects.forEach(subj => addRow(subj, ''));
            } else {
                data.forEach(item => addRow(item.subject, item.content));
            }
            
            document.getElementById('status-msg').textContent = '';
        } catch(e) {
            console.error(e);
            const status = document.getElementById('status-msg');
            status.textContent = '加载失败: ' + e.message;
            status.style.color = '#dc2626';
        }
    }

    function addRow(subject = '', content = '') {
        const div = document.createElement('div');
        div.className = 'homework-item';
        
        const inputSubject = document.createElement('input');
        inputSubject.type = 'text';
        inputSubject.className = 'input-subject';
        inputSubject.placeholder = '科目';
        inputSubject.value = subject;
        
        const inputContent = document.createElement('textarea');
        inputContent.className = 'input-content';
        inputContent.placeholder = '作业内容...';
        inputContent.value = content;
        
        const btnDelete = document.createElement('button');
        btnDelete.className = 'btn-icon btn-delete';
        btnDelete.title = '删除';
        btnDelete.innerHTML = '<i class="ri-close-line"></i>';
        
        div.appendChild(inputSubject);
        div.appendChild(inputContent);
        div.appendChild(btnDelete);
        
        const autoResize = () => {
            inputContent.style.height = 'auto';
            inputContent.style.height = inputContent.scrollHeight + 'px';
        };
        inputContent.addEventListener('input', autoResize);
        setTimeout(autoResize, 0);

        btnDelete.onclick = () => div.remove();
        
        listContainer.appendChild(div);
    }

    document.getElementById('btn-add-row').onclick = () => {
        addRow();
        setTimeout(() => {
            listContainer.scrollTop = listContainer.scrollHeight;
        }, 50);
    };

    document.getElementById('btn-save').addEventListener('click', async () => {
        const date = document.getElementById('date-picker').value;
        const btn = document.getElementById('btn-save');
        const status = document.getElementById('status-msg');
        
        const items = [];
        listContainer.querySelectorAll('.homework-item').forEach(row => {
            const subject = row.querySelector('.input-subject').value.trim();
            const content = row.querySelector('.input-content').value.trim();
            if (subject || content) {
                items.push({ subject, content });
            }
        });

        btn.disabled = true;
        status.textContent = '保存中...';
        
        try {
            logDebug('Saving homework...', items);
            // Send items array directly, index.js will handle storage
            const res = await ipcRenderer.invoke('plugin:call', 'homework-board', 'saveHomework', [date, items]);
            logDebug('Save response', res);
            
            // Check for wrapper result
            const isSuccess = (res.result && res.result.ok) || res.ok;
            
            if (isSuccess) {
                status.textContent = '已保存 ' + new Date().toLocaleTimeString();
                status.style.color = 'var(--accent)';
                logDebug('Save successful');
            } else {
                const error = (res.result && res.result.error) || res.error || 'Unknown error';
                throw new Error(error);
            }
        } catch(e) {
            logDebug('Save failed', e.message, 'error');
            status.textContent = '保存失败: ' + e.message;
            status.style.color = '#dc2626';
        } finally {
            btn.disabled = false;
        }
    });
  </script>
</body>
</html>